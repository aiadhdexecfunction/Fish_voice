<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>BodyDouble test client</title>
	<style>
		body {
			font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
			margin: 24px;
		}

		fieldset {
			border: 1px solid #ddd;
			border-radius: 8px;
			padding: 12px;
			margin-bottom: 16px;
		}

		legend {
			font-weight: 700;
		}

		label {
			display: block;
			margin: 6px 0 2px;
		}

		input[type="text"],
		input[type="number"],
		textarea {
			width: 100%;
			padding: 8px;
			box-sizing: border-box;
		}

		button {
			margin-top: 8px;
			padding: 8px 12px;
			cursor: pointer;
		}

		.row {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 12px;
		}

		#log {
			white-space: pre-wrap;
			background: #fafafa;
			border: 1px solid #eee;
			padding: 10px;
			height: 220px;
			overflow: auto;
		}

		.ok {
			color: #0a7;
		}

		.err {
			color: #b00;
		}

		audio {
			width: 100%;
			margin-top: 8px;
		}

		.grid-3 {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 12px;
		}

		.muted {
			color: #666;
			font-size: 12px;
		}
	</style>
</head>

<body>
	<h1>BodyDouble test client</h1>
	<p class="muted">Set base URL, connect WebSocket, try chat, TTS/ASR, and Pomodoro. Works with the FastAPI server
		you started.</p>

        <fieldset>
                <legend>Config</legend>
                <div class="row">
                        <div>
                                <label>API base URL</label>
                                <input id="baseUrl" type="text" value="http://localhost:8001" />
			</div>
			<div>
				<label>User ID</label>
				<input id="userId" type="text" value="alice" />
			</div>
		</div>
		<div>
			<button id="btnHealth">Health</button>
			<span id="healthOut" class="muted"></span>
                </div>
        </fieldset>

        <fieldset>
                <legend>Accounts</legend>
                <div class="row">
                        <div>
                                <label>Username</label>
                                <input id="accountUsername" type="text" placeholder="alice" />
                                <label>Password</label>
                                <input id="accountPassword" type="password" placeholder="••••••" />
                                <label>Preferred voice model (optional)</label>
                                <input id="accountVoice" type="text" placeholder="voice_ref_id" />
                        </div>
                        <div>
                                <label>Result</label>
                                <div class="muted" id="accountOut">No requests yet.</div>
                                <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
                                        <button id="btnRegister">Register</button>
                                        <button id="btnLogin">Login</button>
                                        <button id="btnGetAccount">Get account</button>
                                        <button id="btnUpdateVoiceModel">Update voice model</button>
                                </div>
                        </div>
                </div>
        </fieldset>

        <fieldset>
                <legend>Personality</legend>
                <div class="row">
                        <div>
                                <label>Available personalities</label>
                                <button id="btnListPersonalities">/personalities</button>
                                <div class="muted" id="personalitiesOut"></div>
                        </div>
                        <div>
                                <label>Set personality ID</label>
                                <input id="personalityId" type="text" placeholder="focus_friend" />
                                <button id="btnSetPersonality">/prefs/{user}/personality</button>
                                <div class="muted" id="personalitySetOut"></div>
                        </div>
                </div>
        </fieldset>

        <fieldset>
                <legend>WebSocket events</legend>
                <div>
                        <button id="btnWsConnect">Connect</button>
			<button id="btnWsDisconnect">Disconnect</button>
			<span id="wsState" class="muted">disconnected</span>
		</div>
		<div id="log"></div>
	</fieldset>

	<fieldset>
		<legend>Chat</legend>
		<label>Message</label>
		<input id="chatText" type="text" value="hi" />
		<button id="btnChatSend">/chat/send</button>
		<div class="muted" id="chatResp"></div>
	</fieldset>

	<fieldset>
		<legend>Voice</legend>
                <div class="grid-3">
                        <div>
                                <label>Text</label>
                                <input id="sayText" type="text" value="Hello from BodyDouble" />
                                <label>Format</label>
                                <input id="sayFormat" type="text" value="mp3" />
                                <button id="btnSay">/voice/say</button>
                                <audio id="player" controls></audio>
                        </div>
                        <div>
                                <label>ASR upload (.wav)</label>
                                <input id="asrFile" type="file" accept="audio/*" />
                                <button id="btnAsr">/voice/asr</button>
                                <div class="muted" id="asrOut"></div>
                        </div>
                        <div>
                                <label>Voice models</label>
                                <button id="btnListVoices">/voice/models</button>
                                <select id="voiceSelect">
                                        <option value="">Default (personality/server)</option>
                                </select>
                                <div class="muted" id="voiceListOut"></div>
                                <label>Override reference ID</label>
                                <input id="voiceRef" type="text" placeholder="reference id (optional)" />
                                <label>Voice preference</label>
                                <button id="btnVoiceOn">Enable voice</button>
                                <button id="btnVoiceOff">Disable voice</button>
                                <div class="muted" id="prefOut"></div>
                        </div>
		</div>
	</fieldset>

	<fieldset>
		<legend>Pomodoro</legend>
		<div class="grid-3">
			<div>
				<label>Focus minutes</label>
				<input id="focusMin" type="number" value="1" />
			</div>
			<div>
				<label>Break minutes</label>
				<input id="breakMin" type="number" value="1" />
			</div>
			<div>
				<label>Cycles</label>
				<input id="cycles" type="number" value="1" />
			</div>
		</div>
		<button id="btnStartPom">/pomodoro/start</button>
		<button id="btnStopPom">/pomodoro/stop</button>
	</fieldset>

        <script>
                const $ = (id) => document.getElementById(id);
                const logEl = $("log");
                function log(msg, cls = "") {
                        const p = document.createElement("div");
                        p.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
                        if (cls) p.className = cls;
                        logEl.appendChild(p); logEl.scrollTop = logEl.scrollHeight;
                }

                function apiBase() {
                        return $("baseUrl").value.replace(/\/$/, "");
                }

                function setAccountOut(message, cls = "") {
                        const out = $("accountOut");
                        if (!out) return;
                        out.textContent = message;
                        out.className = `muted ${cls}`.trim();
                }

                function syncUsername(username) {
                        if (!username) return;
                        $("userId").value = username;
                        const accountInput = $("accountUsername");
                        if (accountInput) accountInput.value = username;
                }

                function currentUsername() {
                        const accountInput = $("accountUsername");
                        if (accountInput) {
                                const value = accountInput.value.trim();
                                if (value) return value;
                        }
                        return $("userId").value.trim();
                }

                const accountInput = $("accountUsername");
                if (accountInput && !accountInput.value) {
                        accountInput.value = $("userId").value;
                }
                if (accountInput) {
                        $("userId").addEventListener("input", (ev) => {
                                if (document.activeElement !== accountInput) {
                                        accountInput.value = ev.target.value;
                                }
                        });
                }

                let ws;
                function wsUrl() {return `${apiBase()}/ws/events/${encodeURIComponent($("userId").value)}`;}

                $("btnWsConnect").onclick = () => {
                        if (ws && ws.readyState === WebSocket.OPEN) return;
                        ws = new WebSocket(wsUrl().replace(/^http/, 'ws'));
                        ws.onopen = () => {$("wsState").textContent = "connected"; log("WS open", "ok");};
                        ws.onclose = () => {$("wsState").textContent = "disconnected"; log("WS closed");};
                        ws.onerror = () => {log("WS error", "err");};
                        ws.onmessage = (ev) => {
                                try {
                                        const data = JSON.parse(ev.data);
                                        log(`event: ${data.event} type=${data.type} text=${data.text || ""}`);
                                        if (data.type === 'speak' && data.text) {
                                                say(data.text, 'mp3');
                                        }
                                } catch {
                                        log("non-JSON message");
                                }
                        };
                };
                $("btnWsDisconnect").onclick = () => {if (ws) ws.close();};

                $("btnHealth").onclick = async () => {
                        try {
                                const r = await fetch(`${apiBase()}/healthz`);
                                const j = await r.json();
                                $("healthOut").textContent = `ok=${j.ok} voice_backend=${j.voice_backend}`;
                        } catch (e) {$("healthOut").textContent = 'error';}
                };

                $("btnRegister").onclick = async () => {
                        const username = currentUsername();
                        const password = $("accountPassword").value;
                        if (!username || !password) {
                                setAccountOut('enter username + password', 'err');
                                return;
                        }
                        setAccountOut('Registering...');
                        const payload = {username, password};
                        const voice = $("accountVoice").value.trim();
                        if (voice) payload.voice_model = voice;
                        try {
                                const r = await fetch(`${apiBase()}/accounts/register`, {
                                        method: 'POST',
                                        headers: {'content-type': 'application/json'},
                                        body: JSON.stringify(payload)
                                });
                                let j = {};
                                try { j = await r.json(); } catch (err) {}
                                if (!r.ok) {
                                        setAccountOut(`error: ${j.error || r.statusText}`, 'err');
                                        return;
                                }
                                syncUsername(username);
                                setAccountOut(`registered. voice=${j.voice_model || 'default'} agent=${j.letta_agent_id || 'n/a'}`, 'ok');
                                log(`account registered for ${username}`, 'ok');
                        } catch (e) {
                                setAccountOut('network error', 'err');
                        }
                };

                $("btnLogin").onclick = async () => {
                        const username = currentUsername();
                        const password = $("accountPassword").value;
                        if (!username || !password) {
                                setAccountOut('enter username + password', 'err');
                                return;
                        }
                        setAccountOut('Logging in...');
                        try {
                                const r = await fetch(`${apiBase()}/accounts/login`, {
                                        method: 'POST',
                                        headers: {'content-type': 'application/json'},
                                        body: JSON.stringify({username, password})
                                });
                                let j = {};
                                try { j = await r.json(); } catch (err) {}
                                if (!r.ok) {
                                        setAccountOut(`error: ${j.error || r.statusText}`, 'err');
                                        return;
                                }
                                syncUsername(j.username || username);
                                $("accountVoice").value = j.voice_model || '';
                                setAccountOut(`login ok. voice=${j.voice_model || 'default'} agent=${j.letta_agent_id || 'n/a'}`, 'ok');
                                log(`login ok for ${j.username || username}`, 'ok');
                        } catch (e) {
                                setAccountOut('network error', 'err');
                        }
                };

                $("btnGetAccount").onclick = async () => {
                        const username = currentUsername();
                        if (!username) {
                                setAccountOut('enter username first', 'err');
                                return;
                        }
                        setAccountOut('Loading...');
                        try {
                                const r = await fetch(`${apiBase()}/accounts/${encodeURIComponent(username)}`);
                                let j = {};
                                try { j = await r.json(); } catch (err) {}
                                if (!r.ok) {
                                        setAccountOut(`error: ${j.error || r.statusText}`, 'err');
                                        return;
                                }
                                $("accountVoice").value = j.voice_model || '';
                                setAccountOut(`voice=${j.voice_model || 'default'} agent=${j.letta_agent_id || 'n/a'}`, 'ok');
                        } catch (e) {
                                setAccountOut('network error', 'err');
                        }
                };

                $("btnUpdateVoiceModel").onclick = async () => {
                        const username = currentUsername();
                        const voice = $("accountVoice").value.trim();
                        if (!username || !voice) {
                                setAccountOut('enter username + voice model', 'err');
                                return;
                        }
                        setAccountOut('Updating voice model...');
                        try {
                                const r = await fetch(`${apiBase()}/accounts/${encodeURIComponent(username)}/voice-model`, {
                                        method: 'POST',
                                        headers: {'content-type': 'application/json'},
                                        body: JSON.stringify({voice_model: voice})
                                });
                                let j = {};
                                try { j = await r.json(); } catch (err) {}
                                if (!r.ok) {
                                        setAccountOut(`error: ${j.error || r.statusText}`, 'err');
                                        return;
                                }
                                setAccountOut(`updated. voice=${j.voice_model}`, 'ok');
                                log(`voice model updated for ${username}`, 'ok');
                        } catch (e) {
                                setAccountOut('network error', 'err');
                        }
                };

                $("btnListPersonalities").onclick = async () => {
                        const container = $("personalitiesOut");
                        container.textContent = 'Loading...';
                        try {
                                const r = await fetch(`${apiBase()}/personalities`);
                                const j = await r.json();
                                while (container.firstChild) container.removeChild(container.firstChild);
                                if (!j.items || !j.items.length) {
                                        container.textContent = 'None';
                                        return;
                                }
                                j.items.forEach((p) => {
                                        const line = document.createElement('div');
                                        line.textContent = `${p.id} — ${p.title}`;
                                        container.appendChild(line);
                                });
                        } catch (e) {
                                container.textContent = 'error';
                        }
                };

                $("btnSetPersonality").onclick = async () => {
                        const personalityId = $("personalityId").value.trim();
                        if (!personalityId) {
                                $("personalitySetOut").textContent = 'enter an id';
                                return;
                        }
                        $("personalitySetOut").textContent = 'Saving...';
                        try {
                                const r = await fetch(`${apiBase()}/prefs/${encodeURIComponent($("userId").value)}/personality`, {
                                        method: 'POST',
                                        headers: {'content-type': 'application/json'},
                                        body: JSON.stringify({personality_id: personalityId}),
                                });
                                const j = await r.json();
                                if (!r.ok) {
                                        $("personalitySetOut").textContent = `error: ${j.error || 'unknown'}`;
                                        return;
                                }
                                $("personalitySetOut").textContent = `set to ${j.personality.id}`;
                        } catch (e) {
                                $("personalitySetOut").textContent = 'error';
                        }
                };

                $("btnChatSend").onclick = async () => {
                        const payload = {user_id: $("userId").value, text: $("chatText").value};
                        const r = await fetch(`${apiBase()}/chat/send`, {method: 'POST', headers: {'content-type': 'application/json'}, body: JSON.stringify(payload)});
                        const j = await r.json();
                        $("chatResp").textContent = `reply: ${j.text} voice_suggested=${j.voice_suggested}`;
                        if (j.voice_suggested && j.text) say(j.text, 'mp3');
                };

                function selectedVoiceId() {
                        const refEl = $("voiceRef");
                        const ref = refEl ? refEl.value.trim() : "";
                        if (ref) return ref;
                        const select = $("voiceSelect");
                        return select && select.value ? select.value : "";
                }

                async function say(text, format) {
                        const payload = {text, format};
                        const referenceId = selectedVoiceId();
                        if (referenceId) payload.reference_id = referenceId;
                        const userId = $("userId").value.trim();
                        if (userId) payload.user_id = userId;
                        const r = await fetch(`${apiBase()}/voice/say`, {
                                method: 'POST', headers: {'content-type': 'application/json'},
                                body: JSON.stringify(payload)
                        });
                        if (!r.ok || !r.body) {log('TTS failed', 'err'); return;}
                        const reader = r.body.getReader();
                        const chunks = [];
                        while (true) {
                                const {value, done} = await reader.read();
                                if (done) break;
                                if (value) chunks.push(value);
                        }
                        const blob = new Blob(chunks, {type: format === 'mp3' ? 'audio/mpeg' : 'audio/wav'});
                        const url = URL.createObjectURL(blob);
                        const audio = $("player");
                        audio.src = url; audio.play();
                }

                $("btnSay").onclick = () => say($("sayText").value, $("sayFormat").value || 'mp3');

                $("btnAsr").onclick = async () => {
                        const f = $("asrFile").files[0];
                        if (!f) {log('pick a file', 'err'); return;}
                        const fd = new FormData();
                        fd.append('file', f);
                        const r = await fetch(`${apiBase()}/voice/asr`, {method: 'POST', body: fd});
                        const j = await r.json();
                        $("asrOut").textContent = JSON.stringify(j);
                };

                $("btnListVoices").onclick = async () => {
                        const out = $("voiceListOut");
                        const select = $("voiceSelect");
                        if (!select) return;
                        if (out) out.textContent = 'Loading...';
                        try {
                                const r = await fetch(`${apiBase()}/voice/models`);
                                const j = await r.json();
                                if (!r.ok) {
                                        if (out) out.textContent = j.error || 'error';
                                        return;
                                }
                                while (select.options.length > 1) select.remove(1);
                                if (!j.items || !j.items.length) {
                                        if (out) out.textContent = 'No models found (SDK only).';
                                        return;
                                }
                                j.items.forEach((m) => {
                                        const opt = document.createElement('option');
                                        opt.value = m.id;
                                        opt.textContent = `${m.title || m.id}`;
                                        select.appendChild(opt);
                                });
                                if (out) out.textContent = `Loaded ${j.items.length} models.`;
                        } catch (e) {
                                if (out) out.textContent = 'error';
                        }
                };

                $("voiceSelect").onchange = () => {
                        const select = $("voiceSelect");
                        if (!select) return;
                        const value = select.value;
                        if (value) {
                                const refEl = $("voiceRef");
                                if (refEl) refEl.value = value;
                        }
                };

                $("btnVoiceOn").onclick = async () => {
                        const r = await fetch(`${apiBase()}/prefs/${encodeURIComponent($("userId").value)}/voice`, {
                                method: 'POST', headers: {'content-type': 'application/json'}, body: JSON.stringify({enabled: true})
                        });
                        const j = await r.json();
                        $("prefOut").textContent = JSON.stringify(j);
                };
                $("btnVoiceOff").onclick = async () => {
                        const r = await fetch(`${apiBase()}/prefs/${encodeURIComponent($("userId").value)}/voice`, {
                                method: 'POST', headers: {'content-type': 'application/json'}, body: JSON.stringify({enabled: false})
                        });
                        const j = await r.json();
                        $("prefOut").textContent = JSON.stringify(j);
                };

                $("btnStartPom").onclick = async () => {
                        const payload = {user_id: $("userId").value, focus_min: +$("focusMin").value, break_min: +$("breakMin").value, cycles: +$("cycles").value};
                        const r = await fetch(`${apiBase()}/pomodoro/start`, {method: 'POST', headers: {'content-type': 'application/json'}, body: JSON.stringify(payload)});
                        log(`pomodoro/start ${r.ok ? 'ok' : 'err'}`);
                };
                $("btnStopPom").onclick = async () => {
                        const payload = {user_id: $("userId").value};
                        const r = await fetch(`${apiBase()}/pomodoro/stop`, {method: 'POST', headers: {'content-type': 'application/json'}, body: JSON.stringify(payload)});
                        log(`pomodoro/stop ${r.ok ? 'ok' : 'err'}`);
                };
        </script>
</body>

</html>
